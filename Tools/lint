#!/bin/sh
#
# lint
# Copyright Â© 2017 Matej Kosiarcik. All rights reserved.
# This file contains lint procedures for project's source code
#

# setup
set -euf
cd "$(dirname "${0}")/.."

# Swift
if command -v swiftlint >/dev/null 2>&1; then
    swiftlint lint 2>/dev/null
else
    printf "%s\n" "warning: swiftlint not found. (tool_not_found)"
fi

# Markdown
if command -v mdl >/dev/null 2>&1; then
    mdl . --git-recurse || true
else
    printf "%s\n" "warning: markdownlint(mdl) not found. (tool_not_found)"
fi

# Yaml
if command -v yamllint >/dev/null 2>&1; then
    yamllint . --format parsable --config-file ".yamllint.yml" || true
else
    printf "%s\n" "warning: yamllint not found. (tool_not_found)"
fi

# Shell
if command -v shellcheck >/dev/null 2>&1; then
    find "./Tools" -type f -not -name "\.*" | while IFS= read -r file; do
        shellcheck --format gcc "${file}" || true
    done
else
    printf "%s\n" "warning: shellcheck not found. (tool_not_found)"
fi
if command -v shfmt >/dev/null 2>&1; then
    find "./Tools" -type f -not -name "\.*" | while IFS= read -r file; do
        shfmt -i 4 -p -l "${file}" \
            | sed -E "s~(.*)~\1: warning: file badly formatted, run 'format' script to resolve (bad_format)~g"
    done
else
    printf "%s\n" "warning: shfmt not found. (tool_not_found)"
fi
# Invoke various shells with scripts for alternative linting via dry runs
if command -v sh >/dev/null 2>&1; then
    find "./Tools" -type f -not -name "\.*" | while IFS= read -r file; do
        sh -n "${file}" || true
    done
else
    printf "%s\n" "warning: sh not found. (tool_not_found)"
fi
if command -v bash >/dev/null 2>&1; then
    find "./Tools" -type f -not -name "\.*" | while IFS= read -r file; do
        bash -n "${file}" || true
        bash --posix -o pipefail -n "${file}" || true
        bash -o posix -o pipefail -n "${file}" || true
    done
else
    printf "%s\n" "warning: bash not found. (tool_not_found)"
fi
if command -v dash >/dev/null 2>&1; then
    find "./Tools" -type f -not -name "\.*" | while IFS= read -r file; do
        dash -n "${file}" || true
    done
else
    printf "%s\n" "warning: dash not found. (tool_not_found)"
fi
if command -v ksh >/dev/null 2>&1; then
    find "./Tools" -type f -not -name "\.*" | while IFS= read -r file; do
        ksh -n "${file}" || true
    done
else
    printf "%s\n" "warning: ksh not found. (tool_not_found)"
fi
if command -v mksh >/dev/null 2>&1; then
    find "./Tools" -type f -not -name "\.*" | while IFS= read -r file; do
        mksh -n "${file}" || true
    done
else
    printf "%s\n" "warning: mksh not found. (tool_not_found)"
fi
if command -v zsh >/dev/null 2>&1; then
    find "./Tools" -type f -not -name "\.*" | while IFS= read -r file; do
        zsh -n "${file}" || true
    done
else
    printf "%s\n" "warning: zsh not found. (tool_not_found)"
fi
if command -v yash >/dev/null 2>&1; then
    find "./Tools" -type f -not -name "\.*" | while IFS= read -r file; do
        yash -n "${file}" || true
        yash --posix -n "${file}" || true
        yash -o posixly-correct -n "${file}" || true
    done
else
    printf "%s\n" "warning: yash not found. (tool_not_found)"
fi
